<?xml version="1.0" encoding="UTF-8"?>
<moya xmlns="http://moyaproject.com"
      xmlns:let="http://moyaproject.com/let"
      xmlns:db="http://moyaproject.com/db"
      xmlns:wiki="http://moyaproject.com/wiki">
    <!-- define your tags here -->

    <tag name="create-page" synopsis="create a new wiki page">
        <signature>
            <attribute name="slug" empty="no">Page slug</attribute>
        </signature>
        <return>
            <db:get-or-create model="#Page" dst="page"
                let:slug="slug"
                initial="title=title:slug">
            </db:get-or-create>
        </return>
    </tag>

    <tag name="create-draft" synopsis="create a new draft">
        <signature>
            <attribute name="page" missing="no">Page</attribute>
            <attribute name="base" required="no">Base Revision</attribute>
        </signature>

        <str dst="initial_content">
# This page has no content, please supply some!
        </str>

        <let base="page.current" if="not base"/>
        <db:get-or-create
            dst="revision"
            model="#Revision"
            initial="title=title:page.slug, content=strip:initial_content, base=base"
            let:version="None"
            let:page="page"
            let:author=".user">
            <db:create
                model="moya.imagelib#Collection"
                dst="revision.images"
                let:slug="page.slug"/>
            <let
                if="base"
                revision.content="base.content"
                revision.title="base.title or title:page.slug"
                revision.markup="base.markup"/>
        </db:get-or-create>
        <return value="revision"/>
    </tag>

    <tag name="publish" synopsis="publish draft">
        <signature>
            <attribute name="page" missing="no">Page</attribute>
            <attribute name="revision" missing="no">Revision</attribute>
        </signature>
        <db:get
            model="#Revision"
            let:page="page"
            let:published="yes"
            orderby="-version"
            dst="newest" />
        <let
            revision.version="(newest.version or 0) + 1"
            revision.published="yes"
            revision.published_time=".now"
            revision.updated_time=".now"
            page.current="revision"
            page.updated_time=".now"
            if="not revision.published"/>
        <log-debug>Published ${page} r${version}</log-debug>
    </tag>


</moya>
