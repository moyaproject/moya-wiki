<?xml version="1.0" encoding="UTF-8"?>
<moya xmlns="http://moyaproject.com"
      xmlns:let="http://moyaproject.com/let"
      xmlns:db="http://moyaproject.com/db"
      xmlns:wiki="http://moyaproject.com/wiki">
    <!-- define your tags here -->

    <tag name="create-page" synopsis="create a new wiki page">
        <signature>
            <attribute name="slug" empty="no">Page slug</attribute>
        </signature>
        <return>
            <db:get-or-create model="#Page" dst="page"
                let:slug="slug"
                initial="title=title:slug">
            </db:get-or-create>
        </return>
    </tag>

    <tag name="create-draft" synopsis="create a new draft">
        <signature>
            <attribute name="page" empty="no">Page</attribute>
            <attribute name="base" required="no">Base Content</attribute>
        </signature>

        <let base="page.current" if="not base"/>
        <db:get-or-create model="#Content" dst="content"
            let:page="page"
            let:title="title:page.slug"
            let:author=".user">
            <db:create model="moya.imagelib#Collection"
                dst="content.images"
                let:slug="page.slug"/>
        </db:get-or-create>
        <let if="base"
            content.content="base.content"
            content.title="base.title"
            content.markup="base.markup"/>
        <return value="content"/>
    </tag>

</moya>
