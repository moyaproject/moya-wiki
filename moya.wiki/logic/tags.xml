<?xml version="1.0" encoding="UTF-8"?>
<moya xmlns="http://moyaproject.com"
      xmlns:let="http://moyaproject.com/let"
      xmlns:db="http://moyaproject.com/db"
      xmlns:wiki="http://moyaproject.com/wiki">
    <!-- define your tags here -->

    <tag name="create-page" synopsis="create a new wiki page">
        <signature>
            <attribute name="slug" empty="no">Page slug</attribute>
        </signature>
        <return>
            <db:get-or-create model="#Page" dst="page"
                let:slug="slug"
                initial="title=title:slug">
            </db:get-or-create>
        </return>
    </tag>

    <tag name="create-draft" synopsis="create a new draft">
        <signature>
            <attribute name="page" empty="no">Page</attribute>
            <attribute name="base" required="no">Base Revision</attribute>
        </signature>

        <str dst="initial_content">
# This page has no content, please supply some!
        </str>

        <let base="page.current" if="not base"/>
        <db:get-or-create model="#Revision" dst="revision"
            let:page="page"
            let:title="title:page.slug"
            let:author=".user">
            <db:create model="moya.imagelib#Collection"
                dst="revision.images"
                let:slug="page.slug"/>
            <let
                revision.content="initial_content"
                revision.version="0"/>
        </db:get-or-create>
        <let if="base"
            revision.content="base.content"
            revision.title="base.title or title:page.slug"
            revision.markup="base.markup"/>
        <return value="revision"/>
    </tag>

</moya>
