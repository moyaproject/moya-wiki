<?xml version="1.0" encoding="UTF-8"?>
<moya xmlns="http://moyaproject.com"
      xmlns:let="http://moyaproject.com/let"
      xmlns:db="http://moyaproject.com/db"
      xmlns:forms="http://moyaproject.com/forms"
      xmlns:wiki="http://moyaproject.com/wiki">

    <mountpoint name="main">
        <!-- A simple default view to start you off -->
        <url route="/{slug}" view="#view.page" name="page"/>
        <url route="/{slug}/create" view="#view.page.create" name="page_create"/>
        <url route="/{slug}/edit" view="#view.page.edit" name="page_edit"/>

    </mountpoint>


    <view libname="view.page" content="#content.page">
        <db:get model="#Page" let:slug=".url.slug" dst="page"/>
    </view>

    <view libname="view.page.create" content="#content.page.create" requires=".user">
        <db:if-exists model="#Page" let:slug=".url.slug">
            <redirect name="page_edit" let:slug=".url.slug"/>
        </db:if-exists>
        <forms:get form="#form.page.create" dst="form"
            let:slug=".url.slug" />
        <forms:validate src="form">
            <redirect name="page" let:slug=".url.slug" if="form.data.create!='yes'"/>
            <wiki:create-page slug=".url.slug"/>
            <redirect name="page_edit" let:slug=".url.slug"/>
        </forms:validate>
    </view>

    <view libname="view.page.edit" content="#content.page.edit" requires=".user">
        <db:get model="#Page" let:slug=".url.slug" dst="page"/>
        <redirect name="page_create" let:slug=".url.slug" if="not page"/>
        <forms:get form="#form.page.edit" src="page.current" dst="form"
            let:page="page" let:content="page.content"/>
        <forms:validate src="form">
            <forms:apply src="form" dst="page"/>
            <redirect name="page" let:slug="page.slug"/>
        </forms:validate>
    </view>

</moya>
